<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEDEON - Scanner d'Affiches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .drag-active { border-color: #667eea !important; background-color: #eef2ff !important; }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    
    <!-- Modal Login -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4 animate-fade-in">
            <div class="text-center mb-6">
                <div class="bg-indigo-500 p-4 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                    <span class="text-3xl">üë§</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Bienvenue sur GEDEON</h2>
                <p class="text-gray-500 mt-2">Entrez votre pseudo pour continuer</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pseudo</label>
                    <input type="text" id="login-pseudo" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                           placeholder="Ex: Eric, Philippe..." maxlength="20" autocomplete="off">
                    <p class="text-xs text-gray-400 mt-1">2-20 caract√®res (lettres, chiffres, _)</p>
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button id="login-btn" onclick="doLogin()" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-semibold hover:bg-indigo-600">Continuer</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="index.html" class="text-gray-500 hover:text-gray-700">‚Üê</a>
                <div class="bg-indigo-500 p-2 rounded-lg"><span class="text-white text-xl">üì∑</span></div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900">GEDEON Scanner</h1>
                    <p class="text-xs text-gray-500">Extracteur IA</p>
                </div>
            </div>
            <div id="user-info" class="flex items-center gap-2 bg-gray-100 px-3 py-2 rounded-full">
                <span>üë§</span>
                <span id="user-pseudo-display" class="font-medium text-gray-700">...</span>
                <button onclick="logout()" class="text-gray-400 hover:text-red-500 ml-1" title="D√©connexion">‚úï</button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="flex-grow max-w-5xl w-full mx-auto px-4 py-6">
        <div class="grid md:grid-cols-2 gap-6">
            
            <!-- Gauche: Zone image -->
            <div class="space-y-4">
                <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center bg-white hover:border-indigo-500">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center text-3xl">üñºÔ∏è</div>
                    <p class="text-gray-600 font-medium mb-4">Choisissez une source</p>
                    
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <button onclick="document.getElementById('camera-input').click()" class="flex items-center justify-center gap-2 bg-indigo-500 text-white px-4 py-3 rounded-xl font-semibold hover:bg-indigo-600 transition">
                            üì∏ Prendre une photo
                        </button>
                        <button onclick="document.getElementById('file-input').click()" class="flex items-center justify-center gap-2 bg-gray-200 text-gray-700 px-4 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">
                            üìÅ Galerie
                        </button>
                    </div>
                    
                    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
                    <input type="file" id="file-input" accept="image/*" class="hidden">
                </div>
                <div id="image-preview" class="hidden bg-white rounded-2xl overflow-hidden shadow-lg relative">
                    <img id="preview-img" class="w-full max-h-96 object-contain bg-gray-100">
                    <button onclick="clearImage()" class="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600">‚úï</button>
                </div>
                <div id="processing-overlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-2xl p-8 text-center">
                        <div class="animate-spin w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-gray-700 font-medium">Analyse en cours...</p>
                    </div>
                </div>
            </div>

            <!-- Droite: R√©sultat -->
            <div class="space-y-4">
                <div id="skeleton-loader" class="hidden bg-white rounded-2xl p-6 shadow-lg animate-pulse">
                    <div class="h-8 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                </div>

                <div id="event-container" class="hidden animate-fade-in">
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-5 text-white">
                            <span id="event-category" class="inline-block px-3 py-1 bg-white/20 rounded-full text-sm mb-2">√âv√©nement</span>
                            <h2 id="event-title" class="text-xl font-bold">Titre</h2>
                        </div>
                        <div class="p-5 space-y-3 text-sm">
                            <div class="flex gap-3"><span class="text-xl">üìÖ</span><div><p class="text-gray-500">Date</p><p id="event-date" class="text-gray-900">-</p><p id="event-time" class="text-gray-600">-</p></div></div>
                            <div class="flex gap-3"><span class="text-xl">üìç</span><div><p class="text-gray-500">Lieu</p><p id="event-venue" class="text-gray-900">-</p><p id="event-address" class="text-gray-600">-</p></div></div>
                            <div class="flex gap-3"><span class="text-xl">üë•</span><div><p class="text-gray-500">Organisateur</p><p id="event-organizer" class="text-gray-900">-</p></div></div>
                            <div class="flex gap-3"><span class="text-xl">üí∞</span><div><p class="text-gray-500">Tarif</p><p id="event-pricing" class="text-gray-900">-</p></div></div>
                            <div id="event-description-container" class="hidden"><p class="text-gray-500 mb-1">Description</p><p id="event-description" class="text-gray-700 bg-gray-50 p-3 rounded-lg">-</p></div>
                            <div id="event-tags-container" class="hidden"><p class="text-gray-500 mb-1">Tags</p><div id="event-tags" class="flex flex-wrap gap-2"></div></div>
                        </div>
                        <div class="p-5 bg-gray-50 border-t space-y-3">
                            <div class="flex items-center gap-3 p-3 bg-white rounded-xl border">
                                <input type="checkbox" id="is-private" class="w-5 h-5">
                                <label for="is-private" class="flex-1"><span class="font-medium text-gray-700">√âv√©nement priv√©</span><p class="text-xs text-gray-400">Visible uniquement par vous</p></label>
                                <span class="text-xl">üîí</span>
                            </div>
                            <div class="flex gap-3">
                                <button id="add-to-gedeon-btn" onclick="addToGedeon()" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-semibold hover:bg-orange-600">‚ûï Ajouter √† GEDEON</button>
                                <button onclick="toggleJson()" class="px-4 py-3 bg-gray-200 rounded-xl hover:bg-gray-300">{ }</button>
                            </div>
                        </div>
                        <div id="json-viewer" class="hidden border-t"><pre id="json-content" class="p-4 bg-gray-900 text-green-400 text-xs overflow-auto max-h-48"></pre></div>
                    </div>
                </div>

                <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-2xl p-5">
                    <span class="text-xl">‚ö†Ô∏è</span> <span id="error-text" class="text-red-600">-</span>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t py-3 text-center text-sm text-gray-400">
        Propuls√© par <span class="font-medium text-indigo-500">Gemini AI</span> ‚Ä¢ GEDEON Scanner v2.0
    </footer>

    <script>
        const SERVER_URL = window.location.origin;
        let currentEventData = null;
        let currentUser = null;
        
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const eventContainer = document.getElementById('event-container');
        const errorMessage = document.getElementById('error-message');
        const processingOverlay = document.getElementById('processing-overlay');
        const skeletonLoader = document.getElementById('skeleton-loader');
        const loginModal = document.getElementById('login-modal');
        
        // === AUTH ===
        function checkAuth() {
            const stored = localStorage.getItem('gedeon_user');
            if (stored) {
                try {
                    currentUser = JSON.parse(stored);
                    document.getElementById('user-pseudo-display').textContent = currentUser.pseudo;
                    loginModal.classList.add('hidden');
                    return true;
                } catch (e) {}
            }
            loginModal.classList.remove('hidden');
            return false;
        }
        
        async function doLogin() {
            const pseudo = document.getElementById('login-pseudo').value.trim();
            const errorDiv = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');
            
            if (pseudo.length < 2 || pseudo.length > 20) {
                errorDiv.textContent = 'Pseudo: 2-20 caract√®res'; errorDiv.classList.remove('hidden'); return;
            }
            if (!/^[a-zA-Z0-9_√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß√Ä√Ç√Ñ√â√à√ä√ã√è√é√î√ô√õ√ú√á]+$/.test(pseudo)) {
                errorDiv.textContent = 'Caract√®res: lettres, chiffres, _'; errorDiv.classList.remove('hidden'); return;
            }
            
            btn.disabled = true; btn.textContent = 'Connexion...'; errorDiv.classList.add('hidden');
            
            try {
                const res = await fetch(`${SERVER_URL}/api/users/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({pseudo})
                });
                const data = await res.json();
                if (data.status === 'success') {
                    currentUser = data.user;
                    localStorage.setItem('gedeon_user', JSON.stringify(currentUser));
                    document.getElementById('user-pseudo-display').textContent = currentUser.pseudo;
                    loginModal.classList.add('hidden');
                } else {
                    errorDiv.textContent = data.message || 'Erreur'; errorDiv.classList.remove('hidden');
                }
            } catch (e) { errorDiv.textContent = 'Erreur serveur'; errorDiv.classList.remove('hidden'); }
            btn.disabled = false; btn.textContent = 'Continuer';
        }
        
        function logout() { if (confirm('D√©connexion ?')) { localStorage.removeItem('gedeon_user'); location.reload(); } }
        document.getElementById('login-pseudo').addEventListener('keypress', e => { if (e.key === 'Enter') doLogin(); });
        
        // === DRAG & DROP ===
        const cameraInput = document.getElementById('camera-input');
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'));
        dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-active'); const f = e.dataTransfer.files[0]; if (f && f.type.startsWith('image/')) handleImageFile(f); });
        fileInput.addEventListener('change', e => { if (e.target.files[0]) handleImageFile(e.target.files[0]); });
        cameraInput.addEventListener('change', e => { if (e.target.files[0]) handleImageFile(e.target.files[0]); });
        
        function handleImageFile(file) {
            if (file.size > 10*1024*1024) { showError('Max 10 MB'); return; }
            const reader = new FileReader();
            reader.onload = e => { previewImg.src = e.target.result; imagePreview.classList.remove('hidden'); dropZone.classList.add('hidden'); analyzeImage(e.target.result, file.type); };
            reader.readAsDataURL(file);
        }
        
        function clearImage() { imagePreview.classList.add('hidden'); dropZone.classList.remove('hidden'); eventContainer.classList.add('hidden'); errorMessage.classList.add('hidden'); fileInput.value = ''; currentEventData = null; }
        function showError(msg) { document.getElementById('error-text').textContent = msg; errorMessage.classList.remove('hidden'); eventContainer.classList.add('hidden'); }
        
        // === ANALYSE ===
        async function analyzeImage(dataUrl, mimeType) {
            eventContainer.classList.add('hidden'); errorMessage.classList.add('hidden');
            skeletonLoader.classList.remove('hidden'); processingOverlay.classList.remove('hidden');
            try {
                const base64 = dataUrl.split(',')[1];
                const res = await fetch(`${SERVER_URL}/api/scanner/analyze`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({image: base64, mimeType}) });
                const result = await res.json();
                if (result.status === 'success') { currentEventData = result.data; displayEventData(result.data); }
                else { throw new Error(result.message || 'Erreur'); }
            } catch (e) { showError(e.message); }
            finally { processingOverlay.classList.add('hidden'); skeletonLoader.classList.add('hidden'); }
        }
        
        function displayEventData(d) {
            eventContainer.classList.remove('hidden');
            document.getElementById('event-title').textContent = d.title || 'Sans titre';
            document.getElementById('event-category').textContent = d.category || '√âv√©nement';
            let dateText = d.startDate || '-'; if (d.endDate && d.endDate !== d.startDate) dateText += ` ‚Üí ${d.endDate}`;
            document.getElementById('event-date').textContent = dateText;
            document.getElementById('event-time').textContent = d.startTime ? (d.startTime + (d.endTime ? ` - ${d.endTime}` : '')) : '-';
            document.getElementById('event-venue').textContent = d.location?.venueName || '-';
            document.getElementById('event-address').textContent = [d.location?.address, d.location?.city].filter(Boolean).join(', ') || '-';
            document.getElementById('event-organizer').textContent = d.organizer?.name || '-';
            document.getElementById('event-pricing').textContent = d.pricing?.isFree ? 'Gratuit' : (d.pricing?.priceRange || '-');
            if (d.description) { document.getElementById('event-description').textContent = d.description; document.getElementById('event-description-container').classList.remove('hidden'); }
            else { document.getElementById('event-description-container').classList.add('hidden'); }
            if (d.tags && d.tags.length) { document.getElementById('event-tags').innerHTML = d.tags.map(t => `<span class="px-2 py-1 bg-indigo-100 text-indigo-600 rounded-full text-xs">${t}</span>`).join(''); document.getElementById('event-tags-container').classList.remove('hidden'); }
            else { document.getElementById('event-tags-container').classList.add('hidden'); }
            document.getElementById('json-content').textContent = JSON.stringify(d, null, 2);
        }
        
        function toggleJson() { document.getElementById('json-viewer').classList.toggle('hidden'); }
        
        // === AJOUTER √Ä GEDEON ===
        async function addToGedeon() {
            if (!currentEventData) return;
            if (!currentUser) { checkAuth(); return; }
            
            const btn = document.getElementById('add-to-gedeon-btn');
            const isPrivate = document.getElementById('is-private').checked;
            btn.disabled = true; btn.textContent = '‚è≥ G√©ocodage...';
            
            const addr = [currentEventData.location?.venueName, currentEventData.location?.address, currentEventData.location?.city].filter(Boolean).join(', ');
            let lat = null, lon = null;
            
            if (addr) {
                try {
                    let res = await fetch(`${SERVER_URL}/api/scanner/geocode`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({address: addr}) });
                    let geo = await res.json();
                    if (geo.status === 'success') { lat = geo.latitude; lon = geo.longitude; }
                    else if (currentEventData.location?.city) {
                        res = await fetch(`${SERVER_URL}/api/scanner/geocode`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({address: currentEventData.location.city}) });
                        geo = await res.json();
                        if (geo.status === 'success') { lat = geo.latitude; lon = geo.longitude; }
                    }
                } catch (e) { console.error('Geocode error:', e); }
            }
            
            btn.textContent = '‚è≥ Enregistrement...';
            
            try {
                const res = await fetch(`${SERVER_URL}/api/scanned`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        title: currentEventData.title,
                        category: currentEventData.category,
                        begin: currentEventData.startDate,
                        end: currentEventData.endDate,
                        startTime: currentEventData.startTime,
                        endTime: currentEventData.endTime,
                        locationName: currentEventData.location?.venueName,
                        city: currentEventData.location?.city,
                        address: currentEventData.location?.address,
                        latitude: lat, longitude: lon,
                        description: currentEventData.description,
                        organizer: currentEventData.organizer?.name,
                        pricing: currentEventData.pricing?.isFree ? 'Gratuit' : currentEventData.pricing?.priceRange,
                        tags: currentEventData.tags || [],
                        is_private: isPrivate
                    })
                });
                const result = await res.json();
                if (result.status === 'success') {
                    const priv = isPrivate ? ' (priv√©)' : ' (public)';
                    if (lat && lon) { if (confirm(`‚úÖ Ajout√©${priv} !\n\nVoir la carte ?`)) window.location.href = 'index.html'; }
                    else { alert(`‚úÖ Ajout√©${priv} mais non g√©olocalis√©.`); }
                } else { alert('‚ùå ' + (result.message || 'Erreur')); }
            } catch (e) { alert('‚ùå Erreur serveur'); }
            
            btn.disabled = false; btn.textContent = '‚ûï Ajouter √† GEDEON';
        }
        
        // Init
        checkAuth();
    </script>
</body>
</html>
